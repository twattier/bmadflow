# Story 1.2: Setup PostgreSQL with pgvector and pgAdmin

## Status

Draft

## Story

**As a** developer,
**I want** PostgreSQL with pgvector extension and pgAdmin running in Docker,
**so that** I have a functional vector-enabled database for development with easy database administration.

## Acceptance Criteria

1. **Docker Compose Configuration Created**:
   - [ ] `docker-compose.yml` file created in project root
   - [ ] PostgreSQL service configured with `ankane/pgvector:latest` image
   - [ ] pgAdmin service configured for database administration
   - [ ] Docker network `bmadflow-network` created
   - [ ] Named volume `postgres_data` configured for data persistence

2. **PostgreSQL Service Running**:
   - [ ] PostgreSQL accessible on `localhost:5432` (configurable via .env)
   - [ ] Database `bmadflow` created automatically
   - [ ] Health check endpoint responding successfully
   - [ ] pgvector extension available (verification query succeeds)

3. **pgAdmin Service Running**:
   - [ ] pgAdmin accessible at `http://localhost:5050`
   - [ ] Server mode disabled for POC (no authentication)
   - [ ] Can connect to PostgreSQL database from pgAdmin

4. **Environment Configuration**:
   - [ ] `.env.example` file created with all database configuration variables
   - [ ] `.env` file in `.gitignore` (if not already)
   - [ ] Environment variables documented in README

5. **Data Persistence Verified**:
   - [ ] Docker volume persists data across `docker-compose down` and `docker-compose up`
   - [ ] Database data survives container restarts

## Tasks / Subtasks

- [ ] **Task 1: Create docker-compose.yml** (AC: 1)
  - [ ] Create `docker-compose.yml` in project root
  - [ ] Configure PostgreSQL service using `ankane/pgvector:latest`
  - [ ] Configure pgAdmin service using `dpage/pgadmin4:latest`
  - [ ] Define `bmadflow-network` bridge network
  - [ ] Define `postgres_data` named volume

- [ ] **Task 2: Configure PostgreSQL Service** (AC: 2)
  - [ ] Set environment variables: POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB
  - [ ] Expose port 5432 with .env variable support
  - [ ] Add health check: `pg_isready -U ${POSTGRES_USER}`
  - [ ] Mount volume for data persistence: `postgres_data:/var/lib/postgresql/data`

- [ ] **Task 3: Configure pgAdmin Service** (AC: 3)
  - [ ] Set PGADMIN_DEFAULT_EMAIL and PGADMIN_DEFAULT_PASSWORD
  - [ ] Disable authentication: `PGADMIN_CONFIG_SERVER_MODE: 'False'`
  - [ ] Expose port 5050 (configurable via .env)
  - [ ] Add dependency on `db` service

- [ ] **Task 4: Create Environment Configuration** (AC: 4)
  - [ ] Create `.env.example` with database configuration template
  - [ ] Include: POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB, POSTGRES_PORT, PGADMIN_PORT
  - [ ] Add `.env` to `.gitignore` if not already present
  - [ ] Update root README.md with environment setup instructions

- [ ] **Task 5: Verify Deployment** (AC: 2, 3, 5)
  - [ ] Run `docker-compose up -d`
  - [ ] Verify PostgreSQL health: `docker-compose ps` shows `db` as healthy
  - [ ] Test pgvector extension: `docker exec bmadflow-db psql -U bmadflow -d bmadflow -c "CREATE EXTENSION IF NOT EXISTS vector;"`
  - [ ] Access pgAdmin at http://localhost:5050
  - [ ] Test data persistence: Create test table, restart containers, verify data exists

## Dev Notes

### Database Configuration

**Image Selection**: Use `ankane/pgvector:latest` Docker image which includes PostgreSQL 15+ with pgvector extension pre-installed.

[Source: architecture/tech-stack.md#database-section]

**pgvector Extension**: Required for vector similarity search with 768-dimensional embeddings from `nomic-embed-text` model. Vector dimension is fixed at 768 and cannot be changed without recreating tables.

[Source: architecture/database-schema.md#chunks-table]

### Docker Compose Service Definitions

**PostgreSQL Service**:
```yaml
db:
  image: ankane/pgvector:latest
  container_name: bmadflow-db
  environment:
    POSTGRES_USER: ${POSTGRES_USER:-bmadflow}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    POSTGRES_DB: ${POSTGRES_DB:-bmadflow}
  ports:
    - "${POSTGRES_PORT:-5432}:5432"
  volumes:
    - postgres_data:/var/lib/postgresql/data
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-bmadflow}"]
    interval: 5s
    timeout: 5s
    retries: 5
  networks:
    - bmadflow-network
```

[Source: architecture/deployment.md#docker-compose-configuration]

**pgAdmin Service**:
```yaml
pgadmin:
  image: dpage/pgadmin4:latest
  container_name: bmadflow-pgadmin
  environment:
    PGADMIN_DEFAULT_EMAIL: admin@bmadflow.local
    PGADMIN_DEFAULT_PASSWORD: admin
    PGADMIN_CONFIG_SERVER_MODE: 'False'  # No auth for POC
    PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
  ports:
    - "${PGADMIN_PORT:-5050}:80"
  depends_on:
    - db
  networks:
    - bmadflow-network
```

[Source: architecture/deployment.md#docker-compose-configuration]

### Environment Variables

Required `.env.example` contents:
```bash
# Database Configuration
POSTGRES_USER=bmadflow
POSTGRES_PASSWORD=changeme_in_production
POSTGRES_DB=bmadflow
DATABASE_URL=postgresql+asyncpg://bmadflow:changeme_in_production@localhost:5432/bmadflow

# Port Configuration (adjust if conflicts exist)
POSTGRES_PORT=5432
PGADMIN_PORT=5050
```

[Source: architecture/deployment.md#environment-variables]

**Port Configurability**: All service ports are configurable via .env to avoid conflicts on developer machines. Use `${PORT:-default}` syntax for environment variable support with fallback defaults.

[Source: architecture/deployment.md#port-configuration]

### Data Persistence

**Named Volume**: `postgres_data` volume persists database data across container restarts. Data survives `docker-compose down` but NOT `docker-compose down -v` (volume deletion).

**Backup Command**:
```bash
docker exec bmadflow-db pg_dump -U bmadflow bmadflow > backup.sql
```

**Restore Command**:
```bash
docker exec -i bmadflow-db psql -U bmadflow bmadflow < backup.sql
```

[Source: architecture/deployment.md#data-persistence]

### Security Considerations (POC-Specific)

⚠️ **Acceptable for POC only** (localhost deployment):
- No pgAdmin authentication (`SERVER_MODE: False`)
- Simple database password in .env file
- HTTP-only communication (no TLS)
- Port exposure to localhost only

**Production would require**: API authentication, HTTPS/TLS, secrets management, network security.

[Source: architecture/deployment.md#security-considerations]

### Verification Steps

**1. Check Service Health**:
```bash
docker-compose ps
# Expected: bmadflow-db shows "Up (healthy)"
```

**2. Verify pgvector Extension**:
```bash
docker exec bmadflow-db psql -U bmadflow -d bmadflow -c "CREATE EXTENSION IF NOT EXISTS vector;"
docker exec bmadflow-db psql -U bmadflow -d bmadflow -c "SELECT * FROM pg_extension WHERE extname = 'vector';"
# Expected: Row returned showing vector extension
```

**3. Test pgAdmin Access**:
- Navigate to http://localhost:5050
- Add server: Host=db, Port=5432, Username=bmadflow, Password=changeme
- Verify connection successful

[Source: architecture/deployment.md#deployment-steps]

### Testing

#### Testing Standards

**Integration Testing**:
- Verify PostgreSQL container starts and becomes healthy
- Verify pgvector extension is available
- Verify pgAdmin can connect to database
- Verify data persistence across container restarts

**No Unit Tests Required**: This is infrastructure setup.

**Manual Testing**:
```bash
# Start services
docker-compose up -d

# Verify health
docker-compose ps

# Test pgvector
docker exec bmadflow-db psql -U bmadflow -d bmadflow -c "CREATE EXTENSION IF NOT EXISTS vector;"

# Test persistence
docker exec bmadflow-db psql -U bmadflow -d bmadflow -c "CREATE TABLE test_table (id SERIAL PRIMARY KEY, name TEXT);"
docker exec bmadflow-db psql -U bmadflow -d bmadflow -c "INSERT INTO test_table (name) VALUES ('test');"
docker-compose down
docker-compose up -d
docker exec bmadflow-db psql -U bmadflow -d bmadflow -c "SELECT * FROM test_table;"
# Expected: test row returned
```

[Source: architecture/testing-strategy.md#backend-testing]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
