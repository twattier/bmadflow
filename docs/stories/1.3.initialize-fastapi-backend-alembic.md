# Story 1.3: Initialize FastAPI Backend with Alembic Migrations

## Status

Draft

## Story

**As a** developer,
**I want** a FastAPI application with Alembic database migrations and a health check endpoint,
**so that** I have a working backend API with database schema version control and deployment validation.

## Acceptance Criteria

1. **FastAPI Application Structure Created**:
   - [ ] `backend/app/main.py` with FastAPI app instance
   - [ ] `backend/app/config.py` for environment configuration using Pydantic Settings
   - [ ] `backend/app/database.py` with async SQLAlchemy engine and session management
   - [ ] CORS middleware configured to allow frontend origin
   - [ ] OpenAPI documentation available at `/docs` and `/redoc`

2. **Alembic Migrations Configured**:
   - [ ] Alembic initialized in `backend/alembic/` directory
   - [ ] `alembic.ini` configured with SQLAlchemy database URL
   - [ ] `alembic/env.py` configured for async migrations with Base metadata
   - [ ] Initial migration created (empty schema for now)
   - [ ] `alembic upgrade head` executes successfully

3. **Health Check Endpoint Implemented**:
   - [ ] `GET /api/health` endpoint returns 200 OK with JSON response
   - [ ] Response includes: `{"status": "ok", "database": "connected", "timestamp": "..."}`
   - [ ] Endpoint verifies database connectivity
   - [ ] Health check accessible at `http://localhost:8000/api/health`

4. **Application Startup Validated**:
   - [ ] Backend starts successfully: `uvicorn app.main:app --reload`
   - [ ] No startup errors in logs
   - [ ] OpenAPI documentation renders correctly at `/docs`
   - [ ] Database connection pool initialized

5. **Environment Configuration**:
   - [ ] `.env` variables loaded via python-dotenv
   - [ ] `DATABASE_URL` environment variable used for database connection
   - [ ] `CORS_ORIGINS` environment variable configures allowed origins
   - [ ] Configuration validates on startup (fail fast if missing required vars)

## Tasks / Subtasks

- [ ] **Task 1: Create Backend Application Structure** (AC: 1)
  - [ ] Create `backend/app/main.py` with FastAPI app instance
  - [ ] Configure CORS middleware with `CORS_ORIGINS` from .env
  - [ ] Create API router mounting at `/api` prefix
  - [ ] Enable OpenAPI documentation at `/docs` and `/redoc`

- [ ] **Task 2: Create Configuration Module** (AC: 1, 5)
  - [ ] Create `backend/app/config.py` using Pydantic BaseSettings
  - [ ] Define settings: `DATABASE_URL`, `BACKEND_PORT`, `CORS_ORIGINS`, `LOG_LEVEL`
  - [ ] Load settings from `.env` file
  - [ ] Add validation for required environment variables

- [ ] **Task 3: Create Database Module** (AC: 1)
  - [ ] Create `backend/app/database.py` with async SQLAlchemy setup
  - [ ] Configure `create_async_engine` with DATABASE_URL
  - [ ] Create `AsyncSession` factory for dependency injection
  - [ ] Define `Base` declarative base for ORM models
  - [ ] Create `get_db()` dependency for route injection

- [ ] **Task 4: Initialize Alembic** (AC: 2)
  - [ ] Run `alembic init alembic` in backend directory
  - [ ] Configure `alembic.ini` with SQLAlchemy URL from config
  - [ ] Update `alembic/env.py` to import Base metadata
  - [ ] Configure async migrations in `env.py`
  - [ ] Create initial migration: `alembic revision --autogenerate -m "Initial schema"`
  - [ ] Test migration: `alembic upgrade head`

- [ ] **Task 5: Implement Health Check Endpoint** (AC: 3)
  - [ ] Create `backend/app/api/v1/health.py` router
  - [ ] Implement `GET /health` endpoint
  - [ ] Add database connectivity check using async session
  - [ ] Return JSON response with status, database connection, and timestamp
  - [ ] Register health router in main.py

- [ ] **Task 6: Verify Backend Deployment** (AC: 4)
  - [ ] Update `.env` with `DATABASE_URL` pointing to PostgreSQL container
  - [ ] Start backend: `uvicorn app.main:app --reload --port 8000`
  - [ ] Verify no startup errors in console
  - [ ] Test health endpoint: `curl http://localhost:8000/api/health`
  - [ ] Access OpenAPI docs: `http://localhost:8000/docs`
  - [ ] Verify database connection in health check response

## Dev Notes

### Backend Architecture Overview

**Layered Architecture**: FastAPI backend follows a layered architecture pattern with Routes → Services → Repositories → Database.

[Source: architecture/backend-architecture.md#architecture-layers]

**Technology Stack**:
- Python 3.11+
- FastAPI 0.110+ (REST API framework with auto OpenAPI docs)
- SQLAlchemy 2.x+ (async ORM)
- Alembic (database migrations)
- uvicorn (ASGI server with hot reload)
- Pydantic Settings (environment configuration)

[Source: architecture/tech-stack.md#backend-language]

### FastAPI Application Structure

**Main Application** (app/main.py):
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.config import settings
from app.api.v1 import health

app = FastAPI(
    title="BMADFlow API",
    description="Documentation hub for BMAD Method projects",
    version="0.1.0"
)

# CORS Configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins.split(","),
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Mount API routes
app.include_router(health.router, prefix="/api", tags=["health"])
```

[Source: architecture/backend-architecture.md#api-layer-routes-controllers]

### Configuration Management

**Settings Module** (app/config.py):
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    database_url: str
    backend_port: int = 8000
    cors_origins: str = "http://localhost:3000"
    log_level: str = "INFO"

    class Config:
        env_file = ".env"

settings = Settings()
```

[Source: architecture/backend-architecture.md#configuration-management]

**Environment Variables** (.env):
```bash
DATABASE_URL=postgresql+asyncpg://bmadflow:changeme@localhost:5432/bmadflow
BACKEND_PORT=8000
CORS_ORIGINS=http://localhost:3000
LOG_LEVEL=INFO
```

[Source: architecture/deployment.md#environment-variables]

### Database Configuration

**Async SQLAlchemy Engine** (app/database.py):
```python
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import declarative_base, sessionmaker
from app.config import settings

engine = create_async_engine(settings.database_url, echo=True)
AsyncSessionLocal = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
Base = declarative_base()

async def get_db():
    """Dependency for route injection."""
    async with AsyncSessionLocal() as session:
        yield session
```

[Source: architecture/backend-architecture.md#repository-layer-data-access]

### Alembic Configuration

**Alembic Setup**: Alembic provides database schema version control with migration scripts. Migrations are auto-generated from SQLAlchemy ORM model changes.

**Async Migration Support** (alembic/env.py):
```python
from app.database import Base
from app.config import settings

# Import all models for autogeneration
from app.models import *  # noqa

config.set_main_option("sqlalchemy.url", settings.database_url)

async def run_migrations_online():
    connectable = create_async_engine(settings.database_url)
    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)
```

[Source: architecture/deployment.md#database-migrations]

**Migration Commands**:
```bash
# Create new migration
alembic revision --autogenerate -m "Description"

# Apply migrations
alembic upgrade head

# Rollback migration
alembic downgrade -1
```

[Source: architecture/deployment.md#alembic-workflow]

### Health Check Implementation

**Health Endpoint** (app/api/v1/health.py):
```python
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import text
from datetime import datetime
from app.database import get_db

router = APIRouter()

@router.get("/health")
async def health_check(db: AsyncSession = Depends(get_db)):
    """
    Health check endpoint validating API and database connectivity.
    Returns 200 OK if healthy, 500 if database unreachable.
    """
    try:
        # Test database connection
        await db.execute(text("SELECT 1"))
        db_status = "connected"
    except Exception as e:
        db_status = f"error: {str(e)}"

    return {
        "status": "ok",
        "database": db_status,
        "timestamp": datetime.utcnow().isoformat()
    }
```

[Source: architecture/backend-architecture.md#api-conventions]

### API Conventions

**REST Endpoint Patterns**:
- Resource naming: Plural nouns (`/api/projects`, `/api/conversations`)
- Nested resources: `/api/projects/{id}/docs`
- Actions as POST: `/api/project-docs/{id}/sync`

**HTTP Methods**:
- `GET` - Retrieve resource(s)
- `POST` - Create resource or trigger action
- `PUT` - Update entire resource
- `DELETE` - Remove resource

**Response Codes**:
- `200 OK` - Successful GET/PUT/DELETE
- `201 Created` - Successful POST creating resource
- `400 Bad Request` - Validation error
- `404 Not Found` - Resource not found
- `500 Internal Server Error` - Server error

[Source: architecture/backend-architecture.md#api-conventions]

### CORS Configuration

**Purpose**: Allow frontend (http://localhost:3000) to call backend API (http://localhost:8000).

**Configuration**:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # Frontend URL
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

[Source: architecture/deployment.md#frontend-cannot-reach-backend]

### Testing

#### Testing Standards

**Integration Testing**:
- Test health check endpoint returns 200 OK
- Test database connectivity check in health endpoint
- Test CORS headers present in response
- Test OpenAPI documentation accessible

**Example Integration Test**:
```python
import pytest
from httpx import AsyncClient
from app.main import app

@pytest.mark.asyncio
async def test_health_check_endpoint():
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.get("/api/health")

    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "ok"
    assert data["database"] == "connected"
    assert "timestamp" in data
```

[Source: architecture/testing-strategy.md#integration-tests]

**Manual Testing**:
```bash
# Start PostgreSQL
docker-compose up -d db

# Start backend
cd backend
uvicorn app.main:app --reload --port 8000

# Test health endpoint
curl http://localhost:8000/api/health

# View OpenAPI docs
open http://localhost:8000/docs
```

**No Unit Tests Required**: This story focuses on infrastructure setup. Unit tests will be added in later stories with business logic.

[Source: architecture/testing-strategy.md#backend-testing]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
