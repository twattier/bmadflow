# Story 5.6: Build Conversation History Panel

## Status
**Done**

## Story
**As a** user,
**I want** to view my recent conversations and resume them,
**so that** I can continue previous discussions.

## Acceptance Criteria

1. **"History" button** in chat header:
   - Icon: Clock or history icon
   - Clicking opens history panel (40% width) sliding in from right

2. **History panel displays** last 10 conversations:
   - Fetched from `GET /api/projects/{id}/conversations`
   - Displayed as cards in vertical list

3. **Each card shows**:
   - **Title**: Conversation title (truncated to 50 chars if longer)
   - **Timestamp**: Relative format ("2 hours ago", "Yesterday", "3 days ago")
   - **LLM Provider**: Badge showing provider + model (e.g., "Ollama - llama3")

4. **Cards sorted** by most recent first (`updated_at DESC`)

5. **Clicking card**:
   - Loads conversation via `GET /api/conversations/{id}`
   - Messages populate chat area
   - History panel closes automatically
   - Chat UI updates to show loaded conversation

6. **"New" button** in header:
   - Only appears when viewing past conversation (not on new conversation)
   - Clicking creates new conversation (resets to "New Conversation" state)

7. **Close button** in panel header:
   - Clicking closes history panel
   - Chat remains unchanged

8. **Empty state** (if no conversations):
   ```
   ðŸ“œ No conversation history yet

   Start a new conversation to get started.
   ```

## Tasks / Subtasks

- [ ] Task 1: Create ConversationHistoryPanel component (AC: 1, 2, 3, 4, 7, 8)
  - [ ] Create `frontend/src/features/chat/ConversationHistoryPanel.tsx`
  - [ ] Use shadcn/ui `Sheet` component for slide-in panel (right side, 40% width)
  - [ ] Accept props: `conversations` (array), `onSelectConversation`, `onClose`
  - [ ] Panel header: "Conversation History" title + Close button (X icon from lucide-react)
  - [ ] Panel body: Map over conversations array to render ConversationCard components
  - [ ] Implement scroll container for conversation list (`overflow-auto`)
  - [ ] Empty state: Show icon + "No conversation history yet" message when conversations.length === 0
  - [ ] Use slide-in animation: 300ms transition on open/close (via shadcn Sheet)
  - [ ] TypeScript interface: `{ conversations: ConversationResponse[], onSelectConversation: (id: string) => void, onClose: () => void, projectId: string }`

- [ ] Task 2: Create ConversationCard component (AC: 3, 4, 5)
  - [ ] Create `frontend/src/features/chat/ConversationCard.tsx`
  - [ ] Use shadcn/ui `Card` component for card styling
  - [ ] Display conversation title: Truncate to 50 chars with ellipsis if longer
  - [ ] Display relative timestamp using `date-fns` library: `formatDistanceToNow(new Date(updated_at), { addSuffix: true })`
  - [ ] Display LLM provider badge: `${provider_name} - ${model_name}` (e.g., "Ollama - llama3")
  - [ ] Use shadcn/ui `Badge` component for provider display
  - [ ] Implement hover effect: Add shadow elevation on hover (`hover:shadow-md`)
  - [ ] Implement click handler: Call `onSelectConversation(conversation.id)` on card click
  - [ ] Make entire card clickable (not just specific elements)
  - [ ] Add cursor-pointer styling on hover
  - [ ] TypeScript interface: `{ conversation: ConversationResponse, onSelectConversation: (id: string) => void }`

- [ ] Task 3: Update Chat page to manage History panel state (AC: 1, 5, 6, 7)
  - [ ] Open `frontend/src/pages/Chat.tsx`
  - [ ] Add state: `historyPanelOpen` (boolean, default false)
  - [ ] Add handler: `handleOpenHistory()` â†’ set `historyPanelOpen` to true
  - [ ] Add handler: `handleCloseHistory()` â†’ set `historyPanelOpen` to false
  - [ ] Add handler: `handleSelectConversation(conversationId)`:
    - [ ] Load conversation via `useConversation(conversationId)` hook
    - [ ] Set `conversationId` state to selected conversation
    - [ ] Close history panel: set `historyPanelOpen` to false
  - [ ] Add "New" button in chat header:
    - [ ] Only render when `conversationId` is not null (viewing past conversation)
    - [ ] Click handler: Reset `conversationId` to null, clear messages
  - [ ] Add "History" button in chat header:
    - [ ] Icon: Clock or History icon from lucide-react
    - [ ] Click handler: Call `handleOpenHistory()`
  - [ ] Render `ConversationHistoryPanel` conditionally: `{historyPanelOpen && <ConversationHistoryPanel ... />}`
  - [ ] Pass handlers to ConversationHistoryPanel component
  - [ ] Ensure History panel and Source panel share the same slot (only one can be open at a time):
    - [ ] If Source panel open when History clicked â†’ close Source, open History
    - [ ] Use state: `activeSidePanel: 'none' | 'source' | 'history'`

- [ ] Task 4: Fetch conversations from API (AC: 2)
  - [ ] Open `frontend/src/api/hooks/useConversations.ts` (created in Story 5.4)
  - [ ] Verify `useConversations(projectId)` hook exists (fetches last 10 conversations)
  - [ ] If missing, implement:
    - [ ] Query key: `['conversations', projectId]`
    - [ ] Query function: `apiClient.get<ConversationResponse[]>(`/projects/${projectId}/conversations`)`
    - [ ] Ordered by `updated_at DESC` (backend handles sorting)
  - [ ] Use `useConversations(projectId)` in Chat page to fetch conversations
  - [ ] Pass fetched conversations to ConversationHistoryPanel component

- [ ] Task 5: Implement conversation loading logic (AC: 5)
  - [ ] Open `frontend/src/api/hooks/useConversations.ts`
  - [ ] Verify `useConversation(conversationId)` hook exists (fetches single conversation with messages)
  - [ ] If missing, implement:
    - [ ] Query key: `['conversations', conversationId, 'messages']`
    - [ ] Query function: `apiClient.get<ConversationWithMessages>(`/conversations/${conversationId}`)`
    - [ ] Returns conversation with messages array
  - [ ] Update Chat page to use `useConversation(conversationId)` when conversation selected
  - [ ] Populate MessageList with loaded conversation messages
  - [ ] Update chat header to show conversation title when viewing past conversation

- [ ] Task 6: Install date-fns library (AC: 3)
  - [ ] Run: `npm install date-fns`
  - [ ] Import `formatDistanceToNow` in ConversationCard component
  - [ ] Usage: `formatDistanceToNow(new Date(conversation.updated_at), { addSuffix: true })`
  - [ ] Examples: "2 minutes ago", "3 hours ago", "2 days ago", "1 month ago"

- [ ] Task 7: Install shadcn/ui Badge component (AC: 3)
  - [ ] Run: `npx shadcn-ui@latest add badge`
  - [ ] Verify Badge component installed in `frontend/src/components/ui/badge.tsx`
  - [ ] Use Badge for LLM provider display in ConversationCard

- [ ] Task 8: Add icons from lucide-react (AC: 1, 6)
  - [ ] Import `Clock` or `History` icon for History button
  - [ ] Import `Plus` or `PlusCircle` icon for New button
  - [ ] Import `X` icon for Close button in History panel header
  - [ ] Usage: `<Clock className="h-5 w-5" />`

- [ ] Task 9: Implement panel state management (AC: 1, 7)
  - [ ] Update Chat page state to manage Source panel and History panel:
    - [ ] State: `activeSidePanel: 'none' | 'source' | 'history'`
    - [ ] Replace separate `historyPanelOpen` and `currentSource` states with unified state
  - [ ] Handler: `handleOpenHistory()` â†’ set `activeSidePanel` to 'history'
  - [ ] Handler: `handleOpenSource(source)` â†’ set `activeSidePanel` to 'source', set `currentSource`
  - [ ] Handler: `handleClosePanel()` â†’ set `activeSidePanel` to 'none'
  - [ ] Render panels conditionally:
    - [ ] `{activeSidePanel === 'history' && <ConversationHistoryPanel ... />}`
    - [ ] `{activeSidePanel === 'source' && <SourcePanel ... />}`

- [ ] Task 10: Style ConversationHistoryPanel with Tailwind CSS (AC: 2, 3, 8)
  - [ ] Panel width: 40% of viewport (`w-2/5`)
  - [ ] Slide-in animation: `transition-transform duration-300 ease-in-out` (via shadcn Sheet)
  - [ ] Panel background: `bg-background` with `border-l`
  - [ ] Header: `flex justify-between items-center p-4 border-b`
  - [ ] Body: `flex-1 overflow-auto p-4`
  - [ ] Conversation card styling: `hover:shadow-md cursor-pointer transition-shadow`
  - [ ] Empty state: centered text with muted color `text-muted-foreground`
  - [ ] Badge styling: `bg-secondary text-secondary-foreground text-xs px-2 py-1 rounded`

- [ ] Task 11: Create component tests for ConversationHistoryPanel and ConversationCard (AC: All)
  - [ ] Create `frontend/tests/components/ConversationHistoryPanel.test.tsx`
  - [ ] Test: renders conversation list when conversations provided
  - [ ] Test: calls onSelectConversation when card clicked
  - [ ] Test: calls onClose when close button clicked
  - [ ] Test: shows empty state when no conversations
  - [ ] Create `frontend/tests/components/ConversationCard.test.tsx`
  - [ ] Test: renders conversation title (truncated if > 50 chars)
  - [ ] Test: renders relative timestamp ("2 hours ago")
  - [ ] Test: renders LLM provider badge
  - [ ] Test: calls onSelectConversation when card clicked
  - [ ] Test: applies hover styling
  - [ ] Mock `date-fns` library with `jest.mock('date-fns')`
  - [ ] Use React Testing Library: `render`, `screen`, `fireEvent`, `waitFor`

- [ ] Task 12: Create integration test for conversation history flow (AC: All)
  - [ ] Create `frontend/tests/integration/conversation-history.test.tsx`
  - [ ] Test full flow:
    - [ ] Render Chat page with existing conversations
    - [ ] Click "History" button â†’ History panel opens
    - [ ] Verify conversation cards displayed
    - [ ] Click conversation card â†’ conversation loads, panel closes
    - [ ] Verify messages displayed in chat area
    - [ ] Click "New" button â†’ conversation resets, New Conversation state appears
    - [ ] Close panel â†’ panel closes, chat unchanged
  - [ ] Mock API responses for conversations and messages
  - [ ] Use React Testing Library + mock axios

- [ ] Task 13: Code Formatting & Linting (All ACs)
  - [ ] Run ESLint: `npm run lint -- --fix`
  - [ ] Run Prettier: `npm run format`
  - [ ] Fix any type errors: `npm run type-check`
  - [ ] Verify all tests pass: `npm test`

- [ ] Task 14: Manual Testing in Browser (All ACs)
  - [ ] Start backend and frontend
  - [ ] Navigate to Chat page
  - [ ] Create multiple test conversations (at least 3)
  - [ ] Click "History" button in chat header
  - [ ] Verify History panel slides in from right (300ms animation)
  - [ ] Verify last 10 conversations displayed as cards
  - [ ] Verify each card shows: title, timestamp, LLM provider badge
  - [ ] Verify cards sorted by most recent first
  - [ ] Test truncated title: Create conversation with long title (> 50 chars)
  - [ ] Click conversation card â†’ verify conversation loads, messages populate
  - [ ] Verify History panel closes after selecting conversation
  - [ ] Verify "New" button appears in header when viewing past conversation
  - [ ] Click "New" button â†’ verify chat resets to New Conversation state
  - [ ] Click "History" button while Source panel open â†’ verify Source closes, History opens
  - [ ] Test Close button: Click X â†’ verify panel closes, chat unchanged
  - [ ] Test empty state: Navigate to project with no conversations, open History panel
  - [ ] Verify relative timestamps update correctly (test with conversations of different ages)

## Dev Notes

### Previous Story Insights

**Source:** [docs/stories/5.5-implement-source-attribution-header-anchor-navigation.md](./5.5-implement-source-attribution-header-anchor-navigation.md)

- **SourcePanel Implementation Complete**: Story 5.5 implemented source panel with 40% width slide-in behavior (Done âœ…, Quality Score: 95/100)
  - Uses shadcn/ui Sheet component for accessible slide-in panel
  - 300ms slide-in animation
  - Close button in header
  - Panel state managed in Chat.tsx
  - Key pattern to reuse: Single side panel slot architecture
- **Chat UI Foundation Ready**: Story 5.4 implemented full chat interface (Done âœ…, Quality Score: 92/100)
  - Chat.tsx page manages conversation state
  - MessageList component displays messages
  - MessageInput component for sending messages
  - LLMProviderSelector for provider selection
- **API Endpoints Available**: Story 5.3 implemented conversation endpoints (Done âœ…, Quality Score: 96/100)
  - **GET** `/api/projects/{id}/conversations` - Returns last 10 conversations ordered by updated_at DESC
  - **GET** `/api/conversations/{id}` - Returns conversation with messages array
  - Response includes: id, project_id, llm_provider_id, title, created_at, updated_at
  - LLM provider joined in response (provider_name, model_name)

**Key Technical Decisions from Previous Stories:**
- Side panels use shadcn/ui Sheet component (40% width, right-side slide-in)
- Only ONE side panel can be open at a time (Source OR History, not both)
- Panel state managed in Chat.tsx page component
- Unified state pattern: `activeSidePanel: 'none' | 'source' | 'history'`

(Dev Notes section truncated for brevity - the full architecture references remain in the actual file)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-10-14 | 1.1 | Story approved - Validation Score: 10/10 (100% PASS), Implementation readiness confirmed | Sarah (Product Owner) |
| 2025-10-14 | 1.2 | Story marked Done - Post-dev/QA validation complete. Quality Score: 85/100. All 8 ACs satisfied, 19/19 tests passing. Minor test gaps noted but non-blocking. | Sarah (Product Owner) |

## Dev Agent Record

*To be filled by Dev Agent*

## QA Results

### Review Date: 2025-10-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Score: 85/100 - Excellent implementation with minor test coverage gaps**

The Story 5.6 implementation demonstrates high-quality craftsmanship with comprehensive component testing and strong adherence to React/TypeScript best practices. The conversation history panel is well-architected with clean separation of concerns (ConversationCard, ConversationHistoryPanel, Chat page orchestration). All 19 component tests pass, covering title truncation, timestamp formatting, LLM provider badges, keyboard navigation, empty states, and panel interactions.

**Strengths:**
- âœ“ Comprehensive component test coverage (19/19 passing)
- âœ“ Excellent accessibility (keyboard nav, ARIA labels, semantic HTML, screen reader support)
- âœ“ Performance optimization with React.memo() on ConversationCard
- âœ“ Clean TypeScript interfaces and strong type safety
- âœ“ Backend optimization with eager loading (selectinload) prevents N+1 queries
- âœ“ Graceful fallback handling ("Unknown Provider" when llm_provider missing)
- âœ“ Proper date-fns integration for relative timestamps

**Areas for Improvement:**
- Integration test for full conversation history flow specified in Task 12 but not implemented
- No automated tests for History button presence in both new/active conversation states
- No automated tests for New button conditional rendering logic

### Refactoring Performed

- **File**: [frontend/src/features/chat/ConversationHistoryPanel.tsx](../../frontend/src/features/chat/ConversationHistoryPanel.tsx)
  - **Change**: Added SheetDescription component with sr-only class
  - **Why**: Radix UI Sheet primitive requires description for WCAG 2.1 AA accessibility compliance. Test suite was emitting warnings about missing `aria-describedby` attribute.
  - **How**: Imported SheetDescription from @/components/ui/sheet and added descriptive text ("View and select from your recent conversations") with sr-only class for screen readers. This satisfies Radix UI's accessibility requirements without affecting visual layout.
  - **Impact**: Eliminated all accessibility warnings from test suite. Improved screen reader experience.

### Compliance Check

- **Coding Standards**: âœ“ PASS
  - TypeScript interfaces properly defined for all components
  - React.memo() used for performance optimization
  - Functional components with hooks (no class components)
  - Accessibility attributes present (aria-label, role, tabIndex)
  - ESLint passing (2 errors are in pre-existing shadcn/ui components, not Story 5.6 code)

- **Project Structure**: âœ“ PASS
  - Components correctly placed in `frontend/src/features/chat/`
  - Tests in `frontend/tests/components/`
  - Types in `frontend/src/api/types/`
  - Follows established import alias patterns (@/ prefix)

- **Testing Strategy**: âœ“ PASS (with minor gaps)
  - Component tests use React Testing Library with user-centric assertions
  - Proper mocking of date-fns library
  - Test coverage for all component behaviors
  - All 19 tests passing
  - Gap: Integration test for full flow not implemented (Task 12)

- **All ACs Met**: âœ“ PASS
  - AC1 (History button): âœ“ Implemented with Clock icon in both states
  - AC2 (Last 10 conversations): âœ“ Backend limits to 10, ordered DESC
  - AC3 (Card content): âœ“ Title truncation, relative time, provider badge all working
  - AC4 (Sorting): âœ“ Backend ordering by updated_at DESC, frontend maintains order
  - AC5 (Click behavior): âœ“ Loads conversation, closes panel
  - AC6 (New button): âœ“ Conditional rendering when conversationId set
  - AC7 (Close button): âœ“ X button closes panel
  - AC8 (Empty state): âœ“ Inbox icon with message when no conversations

### Improvements Checklist

- [x] Added SheetDescription for accessibility compliance (ConversationHistoryPanel.tsx)
- [ ] Add integration test for conversation history flow (Task 12 - tests/integration/conversation-history.test.tsx)
- [ ] Add test for History button presence in both new/active conversation states
- [ ] Add test for New button conditional rendering and state reset
- [ ] Consider keyboard shortcut (Ctrl+H) for History panel (future enhancement)
- [ ] Consider skeleton loading state for conversation cards (future enhancement)

### Security Review

**Status**: âœ“ PASS - No security concerns identified

- No authentication/authorization code modifications
- No sensitive data handling (only conversation metadata: title, timestamps, provider names)
- XSS protection via React's built-in JSX escaping
- SQL injection prevented by SQLAlchemy ORM with parameterized queries (selectinload)
- ARIA labels properly implemented for accessibility without security implications

### Performance Considerations

**Status**: âœ“ PASS - Well-optimized implementation

**Optimizations Present:**
- React.memo() applied to ConversationCard to prevent unnecessary re-renders when parent re-renders
- Backend uses `selectinload(Conversation.llm_provider)` for eager loading (prevents N+1 queries)
- Conversation list limited to 10 items (pagination not needed for MVP)
- Title truncation is O(1) operation (simple string slice)
- date-fns formatDistanceToNow is lightweight and performant

**No Performance Issues:**
- No expensive calculations or infinite loops detected
- No large data sets being processed client-side
- React Query handles caching/refetching efficiently
- Smooth 300ms slide-in animation via shadcn/ui Sheet

### Files Modified During Review

1. [frontend/src/features/chat/ConversationHistoryPanel.tsx](../../frontend/src/features/chat/ConversationHistoryPanel.tsx) - Added SheetDescription for accessibility

**Note to Dev**: Please add this file to the story's File List section when updating story status.

### Requirements Traceability Matrix

**AC1: History button in chat header**
- **Coverage**: âœ“ Button implemented in [Chat.tsx:127-135](../../frontend/src/pages/Chat.tsx#L127-L135) (new conversation) and [Chat.tsx:169-177](../../frontend/src/pages/Chat.tsx#L169-L177) (active conversation)
- **Gap**: No automated test verifying button presence in both states

**AC2: Last 10 conversations from API**
- **Coverage**: âœ“ Backend [conversation_repository.py:55-75](../../backend/app/repositories/conversation_repository.py#L55-L75) limits to 10, ordered DESC
- **Coverage**: âœ“ Component test [ConversationHistoryPanel.test.tsx:75-89](../../frontend/tests/components/ConversationHistoryPanel.test.tsx#L75-L89) verifies rendering
- **Gap**: No integration test verifying API fetch

**AC3: Card shows title/timestamp/provider**
- **Coverage**: âœ“ Title rendering test [ConversationCard.test.tsx:32-36](../../frontend/tests/components/ConversationCard.test.tsx#L32-L36)
- **Coverage**: âœ“ Title truncation test [ConversationCard.test.tsx:78-96](../../frontend/tests/components/ConversationCard.test.tsx#L78-L96)
- **Coverage**: âœ“ Timestamp test [ConversationCard.test.tsx:38-42](../../frontend/tests/components/ConversationCard.test.tsx#L38-L42)
- **Coverage**: âœ“ Provider badge test [ConversationCard.test.tsx:44-48](../../frontend/tests/components/ConversationCard.test.tsx#L44-L48)

**AC4: Cards sorted by most recent**
- **Coverage**: âœ“ Order verification test [ConversationHistoryPanel.test.tsx:160-177](../../frontend/tests/components/ConversationHistoryPanel.test.tsx#L160-L177)
- **Coverage**: âœ“ Backend ordering [conversation_repository.py:72](../../backend/app/repositories/conversation_repository.py#L72)

**AC5: Click card loads conversation**
- **Coverage**: âœ“ Click handler test [ConversationCard.test.tsx:50-58](../../frontend/tests/components/ConversationCard.test.tsx#L50-L58)
- **Coverage**: âœ“ Selection callback test [ConversationHistoryPanel.test.tsx:91-109](../../frontend/tests/components/ConversationHistoryPanel.test.tsx#L91-L109)
- **Coverage**: âœ“ State update logic [Chat.tsx:96-99](../../frontend/src/pages/Chat.tsx#L96-L99)
- **Gap**: No integration test for full flow (messages loading, panel closing)

**AC6: New button (conditional)**
- **Coverage**: âœ“ Conditional rendering [Chat.tsx:158-168](../../frontend/src/pages/Chat.tsx#L158-L168)
- **Coverage**: âœ“ Handler implementation [Chat.tsx:101-106](../../frontend/src/pages/Chat.tsx#L101-L106)
- **Gap**: No automated test for conditional logic

**AC7: Close button**
- **Coverage**: âœ“ Close button test [ConversationHistoryPanel.test.tsx:111-126](../../frontend/tests/components/ConversationHistoryPanel.test.tsx#L111-L126)
- **Coverage**: âœ“ Implementation [ConversationHistoryPanel.tsx:28-35](../../frontend/src/features/chat/ConversationHistoryPanel.tsx#L28-L35)

**AC8: Empty state**
- **Coverage**: âœ“ Empty state test [ConversationHistoryPanel.test.tsx:128-141](../../frontend/tests/components/ConversationHistoryPanel.test.tsx#L128-L141)
- **Coverage**: âœ“ Implementation [ConversationHistoryPanel.tsx:40-46](../../frontend/src/features/chat/ConversationHistoryPanel.tsx#L40-L46)

### Gate Status

**Gate**: CONCERNS â†’ [docs/qa/gates/5.6-build-conversation-history-panel.yml](../qa/gates/5.6-build-conversation-history-panel.yml)

**Decision Rationale**: Implementation quality is excellent with 19/19 tests passing and strong adherence to coding standards. The CONCERNS gate is due to three minor test coverage gaps (all low-medium severity):
1. Missing integration test for full conversation history flow (Task 12 specified but not implemented)
2. No automated test for History button presence verification
3. No automated test for New button conditional rendering

These gaps do not block functionality (manual testing can verify), but should be addressed for complete test coverage and regression protection.

### Recommended Status

âœ“ **Ready for Done** (with understanding of test gaps)

The implementation is production-ready. The test gaps are documentation/regression protection concerns, not functional blockers. Team can choose to:
- **Option A**: Mark as Done now, create follow-up story for integration tests
- **Option B**: Add the 3 missing tests (estimated 1-2 hours) before marking Done

Story owner decides based on sprint timeline and risk tolerance.
